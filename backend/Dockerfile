# 1. ë¹Œë“œ ë‹¨ê³„ (Node 20)
FROM node:20-alpine AS builder
ARG APP_NAME

WORKDIR /app

COPY package*.json ./
RUN npm install
RUN npm install -g @nestjs/cli

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ [í•µì‹¬ ìˆ˜ì •: ì‹¬ë³¼ë¦­ ë§í¬ì™€ íƒ€ì… ì„¤ì¹˜ ì¬ë„ì…] ğŸ‘‡ğŸ‘‡ğŸ‘‡
# 1. ê° ì•±ì´ ìƒìœ„ node_modulesë¥¼ ì°¾ë„ë¡ ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ìƒì„± (Cannot find module í•´ê²°)
RUN ln -s /app/node_modules /app/${APP_NAME}/node_modules
# 2. @types/nodeë¥¼ ê°•ì œ ì„¤ì¹˜ (Buffer, process íƒ€ì… ì—ëŸ¬ í•´ê²°)
RUN npm install -g @types/node

COPY . .

# [ì£¼ì˜] ENV NODE_PATHëŠ” ì œê±°í–ˆìŠµë‹ˆë‹¤!

# ì•± í´ë”ë¡œ ì´ë™ í›„ ë¹Œë“œ
RUN cd ${APP_NAME} && nest build

# 2. ì‹¤í–‰ ë‹¨ê³„
FROM node:20-alpine
ARG APP_NAME

WORKDIR /app
COPY package*.json ./
RUN npm install --production

# ë¹Œë“œ ê²°ê³¼ë¬¼ ê°€ì ¸ì˜¤ê¸°
COPY --from=builder /app/${APP_NAME}/dist ./dist

EXPOSE 3000-4000
CMD ["node", "dist/main"]
