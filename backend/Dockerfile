# 1. ë¹Œë“œ ë‹¨ê³„ (Node 20)
FROM node:20-alpine AS builder
ARG APP_NAME

WORKDIR /app

COPY package*.json ./
RUN npm install
RUN npm install -g @nestjs/cli

COPY . .

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ [í•µì‹¬ ìˆ˜ì •: ì‹¬ë³¼ë¦­ ë§í¬ ë° íƒ€ì… ì„¤ì¹˜] ğŸ‘‡ğŸ‘‡ğŸ‘‡
# 1. ê° ì•±ì´ ìƒìœ„ node_modulesë¥¼ ì°¾ë„ë¡ ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
#    (Cannot find module '@nestjs/config' í•´ê²°)
RUN ln -s /app/node_modules /app/${APP_NAME}/node_modules
# 2. ì „ì—­ì—ì„œ TS ê¸°ë³¸ íƒ€ì…(@types/node)ì„ ì°¾ë„ë¡ ê°•ì œ ì„¤ì¹˜í•©ë‹ˆë‹¤.
#    (Cannot find name 'Buffer', 'process' ì—ëŸ¬ í•´ê²°)
RUN npm install -g @types/node

# ì•± í´ë”ë¡œ ì´ë™ í›„ ë¹Œë“œ
RUN cd ${APP_NAME} && nest build

# 2. ì‹¤í–‰ ë‹¨ê³„
FROM node:20-alpine
ARG APP_NAME

WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY --from=builder /app/dist/apps/${APP_NAME} ./dist

EXPOSE 3000-4000
CMD ["node", "dist/main"]
