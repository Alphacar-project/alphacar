version: '3.8'

networks:
  backnet:
    driver: bridge

services:
  # =======================================================
  # 1. Traefik (Gateway)
  # =======================================================
  traefik:
    image: traefik:3.6
    container_name: traefik
    restart: always

    environment:
      - DOCKER_API_VERSION=1.44

    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:9090"
      - "--api.insecure=true"

      - "--log.level=DEBUG"
      - "--accesslog=true"
    ports:
      - "9090:9090"
      - "10000:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - backnet

  # =======================================================
  # 2. Nginx
  # =======================================================
  nginx:
    image: 192.168.0.169/alphacar-project/alphacar-nginx:${IMAGE_TAG:-1.0.0}
    container_name: nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "8000:8000"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - traefik
    networks:
      - backnet

  # =======================================================
  # 3. Frontend
  # =======================================================
  frontend:
    image: 192.168.0.169/alphacar-project/alphacar-frontend:${IMAGE_TAG:-1.0.0}
    container_name: frontend
    restart: always
    environment:
      - API_URL=https://192.168.0.160.nip.io/api
      - PORT=8000

      # âœ… ì¶”ê°€: "ì´ ê²½ë¡œì— ìˆëŠ” ì¸ì¦ì„œëŠ” ë¯¿ì–´ë¼" ì„¤ì •
      - NODE_EXTRA_CA_CERTS=/etc/ssl/certs/selfsigned.crt
    expose:
      - "8000"

    volumes:
      # âœ… ì¶”ê°€: í˜¸ìŠ¤íŠ¸ì˜ ì¸ì¦ì„œ íŒŒì¼ì„ ì»¨í…Œì´ë„ˆ ì•ˆìœ¼ë¡œ ë„£ì–´ì¤Œ (ì½ê¸° ì „ìš©)
      # (ì£¼ì˜: í˜¸ìŠ¤íŠ¸ ê²½ë¡œ /etc/nginx/ssl ì— ì¸ì¦ì„œê°€ ìˆë‹¤ê³  ê°€ì •)
      - /etc/nginx/ssl/selfsigned.crt:/etc/ssl/certs/selfsigned.crt:ro

    networks:
      - backnet

  # =======================================================
  # 4. Backend Microservices (í™˜ê²½ë³€ìˆ˜ ëŒ€ê±° ìˆ˜ì •!)
  # =======================================================

  # [Main Backend] - MongoDB + Redis
  main-backend:
    image: 192.168.0.169/alphacar-project/alphacar-main:${IMAGE_TAG:-1.0.0}
    container_name: main_backend
    restart: always
    networks:
      - backnet
    environment:
      - PORT=3002
      # ğŸ‘‡ [ì½”ë“œ ê¸°ë°˜ ìˆ˜ì •] MongoDB ì„¤ì • ë¶„ë¦¬
      - DATABASE_HOST=192.168.0.201
      - DATABASE_PORT=27017
      - DATABASE_USER=triple_user
      - DATABASE_PASSWORD=triple_password
      - DATABASE_NAME=triple_db
      # Redis
      - REDIS_HOST=192.168.0.175
      - REDIS_PORT=6379
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.main.loadbalancer.server.port=3002"
      - "traefik.http.middlewares.strip-api.stripprefix.prefixes=/api"
      - "traefik.http.routers.main.entrypoints=web"

      - "traefik.http.routers.main.rule=PathPrefix(`/api/main`) || PathPrefix(`/api/history`) || PathPrefix(`/api/recent-views`) || PathPrefix(`/api/sales`) || PathPrefix(`/api/brands`) || PathPrefix(`/api/favorites`) || PathPrefix(`/api/log-view`) || PathPrefix(`/api/makers`) || PathPrefix(`/api/models`) || PathPrefix(`/api/trims`) || PathPrefix(`/api/cars`) || PathPrefix(`/api/review-analysis`)"

      - "traefik.http.routers.main.middlewares=strip-api"
      - "traefik.http.routers.main-detail.rule=PathPrefix(`/api/vehicles/detail`)"
      - "traefik.http.routers.main-detail.entrypoints=web"
      - "traefik.http.routers.main-detail.priority=100"
      - "traefik.http.routers.main-detail.middlewares=strip-api"

  # [Quote Backend] - MongoDB
  quote-backend:
    image: 192.168.0.169/alphacar-project/alphacar-quote:${IMAGE_TAG:-1.0.0}
    container_name: quote_backend
    restart: always
    networks:
      - backnet
    environment:
      - PORT=3003
      # MongoDB
      - DATABASE_HOST=192.168.0.201
      - DATABASE_PORT=27017
      - DATABASE_USER=triple_user
      - DATABASE_PASSWORD=triple_password
      - DATABASE_NAME=triple_db
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.quote.loadbalancer.server.port=3003"
      - "traefik.http.middlewares.strip-api-quote.stripprefix.prefixes=/api"
      - "traefik.http.routers.quote.rule=PathPrefix(`/api/vehicles`) || PathPrefix(`/api/estimate`) || PathPrefix(`/api/quote`)"
      - "traefik.http.routers.quote.entrypoints=web"
      - "traefik.http.routers.quote.priority=50"
        #  - "traefik.http.routers.quote.middlewares=strip-api-quote"

  # [Search Backend] - MongoDB
  search-backend:
    image: 192.168.0.169/alphacar-project/alphacar-search:${IMAGE_TAG:-1.0.0}
    container_name: search_backend
    restart: always
    networks:
      - backnet
    environment:
      - PORT=3007
      # MongoDB
      - DATABASE_HOST=192.168.0.201
      - DATABASE_PORT=27017
      - DATABASE_USER=triple_user
      - DATABASE_PASSWORD=triple_password
      - DATABASE_NAME=triple_db
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.search.loadbalancer.server.port=3007"
      - "traefik.http.middlewares.strip-api-search.stripprefix.prefixes=/api"
      - "traefik.http.routers.search.rule=PathPrefix(`/api/search`)"
      - "traefik.http.routers.search.entrypoints=web"
      - "traefik.http.routers.search.middlewares=strip-api-search"

  # [MyPage Backend] - MariaDB + MongoDB (â˜…í™•ì¸ í•„ìš”)
  mypage-backend:
    image: 192.168.0.169/alphacar-project/alphacar-mypage:${IMAGE_TAG:-1.0.0}
    container_name: mypage_backend
    restart: always
    networks:
      - backnet
    environment:
      - PORT=3006

      # 1. MongoDB (ì½”ë“œ ê¸°ì¤€ DATABASE_... ì‚¬ìš©)
      - DATABASE_HOST=192.168.0.201
      - DATABASE_PORT=27017
      - DATABASE_USER=triple_user
      - DATABASE_PASSWORD=triple_password
      - DATABASE_NAME=triple_db

      # 2. MariaDB (Users) - ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ ë³„ë„ ë³€ìˆ˜ëª… ì‚¬ìš© (ì½”ë“œ í™•ì¸ í•„ìš”!)
      # ë§Œì•½ mypage ì½”ë“œì—ì„œë„ MariaDBë¥¼ DATABASE_HOSTë¡œ ì°¾ëŠ”ë‹¤ë©´ ìˆ˜ì •í•´ì•¼ í•¨
      - MARIADB_HOST=211.46.52.151
      - MARIADB_PORT=15432
      - MARIADB_USER=team1
      - MARIADB_PASSWORD=Gkrtod1@
      - MARIADB_DATABASE=team1
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.mypage.loadbalancer.server.port=3006"
      - "traefik.http.middlewares.strip-api-mypage.stripprefix.prefixes=/api"
      - "traefik.http.routers.mypage.rule=PathPrefix(`/api/mypage`) || PathPrefix(`/auth`)"
      - "traefik.http.routers.mypage.entrypoints=web"
      - "traefik.http.routers.mypage.middlewares=strip-api-mypage"

  # [Community Backend] - MariaDB
  community-backend:
    image: 192.168.0.169/alphacar-project/alphacar-community:${IMAGE_TAG:-1.0.0}
    container_name: community_backend
    restart: always
    networks:
      - backnet
    environment:
      - PORT=3005
      # MariaDB (Community) - TypeORM í‘œì¤€ ë³€ìˆ˜ëª… ê°€ì •
      - MARIADB_TYPE=mariadb
      - MARIADB_HOST=211.46.52.151
      - MARIADB_PORT=15432
      - MARIADB_USERNAME=team1
      - MARIADB_PASSWORD=Gkrtod1@
      - MARIADB_DATABASE=team1
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.community.loadbalancer.server.port=3005"
      - "traefik.http.middlewares.strip-api-comm.stripprefix.prefixes=/api"
      - "traefik.http.routers.community.rule=PathPrefix(`/api/community`)"
      - "traefik.http.routers.community.entrypoints=web"
      - "traefik.http.routers.community.middlewares=strip-api-comm"

  # [AI Chat Backend] - MongoDB
  aichat-backend:
    image: 192.168.0.169/alphacar-project/alphacar-aichat:${IMAGE_TAG:-1.0.0}
    container_name: aichat_backend
    restart: always
    networks:
      - backnet
    environment:
      - PORT=4000
      # MongoDB
      - DATABASE_HOST=192.168.0.201
      - DATABASE_PORT=27017
      - DATABASE_USER=proj
      - DATABASE_PASSWORD=pass123
      - DATABASE_NAME=triple_db

      # 2. AWS Bedrock ìê²© ì¦ëª… (ì¶”ê°€ë¨!)
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=AKIAVR45JBJOYYJBPZ5M
      - AWS_SECRET_ACCESS_KEY=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

      # 3. Bedrock ëª¨ë¸ ë° ê°€ë“œë ˆì¼ ì„¤ì • (ì¶”ê°€ë¨!)
      - BEDROCK_GUARDRAIL_ID=nfdfeln14bg7
      - BEDROCK_GUARDRAIL_VERSION=DRAFT
      - BEDROCK_EMBEDDING_MODEL_ID=amazon.titan-embed-text-v2:0
      - BEDROCK_LLM_MODEL_ID=meta.llama3-3-70b-instruct-v1:0

    volumes:
      # 1. ì•„ê¹Œ í•™ìŠµì‹œí‚¨ ë²¡í„° DB í´ë” ì—°ê²° (ì´ê²Œ ì—†ì–´ì„œ ê²€ìƒ‰ì´ ì•ˆ ëìŒ)
      - ../backend/aichat/vector_store:/app/vector_store

    labels:
      - "traefik.enable=true"
      - "traefik.http.services.aichat.loadbalancer.server.port=4000"
      - "traefik.http.middlewares.ai-rewrite.replacepathregex.regex=^/api/chat/(.*)"
      - "traefik.http.middlewares.ai-rewrite.replacepathregex.replacement=/chat/$$1"
      - "traefik.http.routers.aichat.rule=PathPrefix(`/api/chat`)"
      - "traefik.http.routers.aichat.entrypoints=web"
      - "traefik.http.routers.aichat.middlewares=ai-rewrite"

  # [Drive Backend] - MongoDB
  drive-backend:
    image: 192.168.0.169/alphacar-project/alphacar-drive:${IMAGE_TAG:-1.0.0}
    container_name: drive_backend
    restart: always
    networks:
      - backnet
    environment:
      - PORT=3008
      # MongoDB
      - DATABASE_HOST=192.168.0.201
      - DATABASE_PORT=27017
      - DATABASE_USER=triple_user
      - DATABASE_PASSWORD=triple_password
      - DATABASE_NAME=triple_db
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.drive.loadbalancer.server.port=3008"
      - "traefik.http.middlewares.strip-api-drive.stripprefix.prefixes=/api"
      - "traefik.http.routers.drive.rule=PathPrefix(`/api/drive`)"
      - "traefik.http.routers.drive.entrypoints=web"
      - "traefik.http.routers.drive.middlewares=strip-api-drive"

